version: '3.8'

services:
  # ======================
  # DATABASE
  # ======================
  mongodb:
    image: mongo:latest
    container_name: observability_mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
      MONGO_INITDB_DATABASE: tasks_db
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - observability_network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ======================
  # BACKEND
  # ======================
  backend:
    build:
      context: ./Application-Code/backend
      dockerfile: Dockerfile
    container_name: observability_backend
    ports:
      - "5000:3500"
    environment:
      - MONGO_CONN_STR=mongodb://admin:password123@mongodb:27017/tasks_db?authSource=admin
      - USE_DB_AUTH=true
      - MONGO_USERNAME=admin
      - MONGO_PASSWORD=password123
      - PORT=3500
      - NODE_ENV=production
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - observability_network
    restart: unless-stopped

  # ======================
  # FRONTEND
  # ======================
  frontend:
    build:
      context: ./Application-Code/frontend
      dockerfile: Dockerfile
    container_name: observability_frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_BACKEND_URL=http://localhost:5000/api/tasks
    depends_on:
      - backend
    networks:
      - observability_network
    restart: unless-stopped

  # ======================
  # MONITORING STACK
  # ======================

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - ./monitoring-stack/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - observability_network
    restart: unless-stopped

  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - observability_network
    restart: unless-stopped

  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    user: root
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yml
    volumes:
      - ./monitoring-stack/loki/loki-config.yml:/etc/loki/local-config.yml
      - loki_data:/loki
    environment:
      - LOKI_CONFIG_FILE=/etc/loki/local-config.yml
    networks:
      - observability_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 10s
      timeout: 5s
      retries: 5


  promtail:
    image: grafana/promtail:2.9.0
    container_name: promtail
    volumes:
      - ./monitoring-stack/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/promtail-config.yml
    networks:
      - observability_network
    restart: unless-stopped

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.0
    container_name: cadvisor
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    networks:
      - observability_network
    restart: unless-stopped

# ======================
# VOLUMES
# ======================
volumes:
  mongodb_data:
  mongodb_config:
  grafana_data:
  loki_data:

# ======================
# NETWORK
# ======================
networks:
  observability_network:
    driver: bridge
